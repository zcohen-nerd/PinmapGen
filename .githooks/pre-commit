#!/bin/bash
#
# PinmapGen Pre-commit Hook
#
# This hook automatically regenerates pinmap files when source files change.
# It ensures that generated outputs stay in sync with input files.

set -e

echo "üîß PinmapGen pre-commit hook running..."

# Check if we have any changes in hardware/exports/
HARDWARE_CHANGED=$(git diff --cached --name-only | grep -E '^hardware/exports/' || true)

if [ -n "$HARDWARE_CHANGED" ]; then
    echo "üìÅ Hardware export files changed:"
    echo "$HARDWARE_CHANGED"
    
    # Check if we have a Python environment
    if command -v python >/dev/null 2>&1; then
        echo "üîÑ Regenerating pinmaps..."
        
        # Find CSV files in hardware/exports/
        CSV_FILES=$(find hardware/exports/ -name "*.csv" 2>/dev/null || true)
        
        if [ -n "$CSV_FILES" ]; then
            for csv_file in $CSV_FILES; do
                echo "üìã Processing $csv_file..."
                
                # Detect MCU type from filename or default to rp2040
                mcu_type="rp2040"
                if [[ "$csv_file" == *"stm32"* ]]; then
                    mcu_type="stm32g0"
                elif [[ "$csv_file" == *"esp32"* ]]; then
                    mcu_type="esp32"
                fi
                
                echo "üîç Detected MCU type: $mcu_type"
                
                # Run the generator
                python -m tools.pinmapgen.cli \
                    --csv "$csv_file" \
                    --mcu "$mcu_type" \
                    --mcu-ref U1 \
                    --out-root . \
                    --mermaid
            done
            
            # Stage the regenerated files
            echo "üì§ Staging regenerated pinmap files..."
            git add pinmaps/
            git add firmware/micropython/
            git add firmware/include/
            git add firmware/docs/
            
            echo "‚úÖ Pinmaps regenerated and staged successfully!"
        else
            echo "‚ö†Ô∏è  No CSV files found in hardware/exports/"
        fi
    else
        echo "‚ùå Python not found! Please install Python to use auto-regeneration."
        echo "   You can manually regenerate with:"
        echo "   python -m tools.pinmapgen.cli --csv hardware/exports/sample_netlist.csv --mcu rp2040 --mcu-ref U1 --out-root . --mermaid"
        exit 1
    fi
else
    echo "üìã No hardware export changes detected, skipping regeneration."
fi

echo "üéâ Pre-commit hook completed successfully!"